<html>

<head>
    <title>Visitors QRScanner</title>
    <link rel="stylesheet" href="style.css">

<body>
    <div class="flex-container">
        <div>
            <div id="qr-reader" style="width:500px"></div>
            <div id="qr-reader-results"></div>
        </div>
    </div>
</body>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    docReady(function () {
        var resultContainer = document.getElementById('qr-reader-results');
        var lastResult, countResults = 0;
        var responseText;

        var html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", { fps: 10, qrbox: 250 });

        function onScanSuccess(decodedText, decodedResult) {

            var url = "https://api.konkat.gr/get_visitor/" + decodedText;

            var xhr = new XMLHttpRequest();
            xhr.open("GET", url);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    console.log(xhr.status);
                    console.log(xhr.responseText);
                    responseText = xhr.responseText;
                }

            };

            xhr.send();

            if (responseText === 0) {
                Swal.fire({
                    title: 'Reject',
                    text: decodedText,
                    icon: 'error',
                    confirmButtonText: 'OK!'
                })
            } else {
                Swal.fire({
                    title: 'Accepted',
                    text: decodedText,
                    icon: 'success',
                    confirmButtonText: 'OK!'
                })

            }

            // if (decodedText !== lastResult) {
            //     ++countResults;
            //     lastResult = decodedText;
            //     // Handle on success condition with the decoded message.
            //     console.log(`Scan result ${decodedText}`, decodedResult);

            //     Swal.fire({
            //         title: decodedText,
            //         text: 'You code is ' + responseText,
            //         icon: 'success',
            //         confirmButtonText: 'OK!'
            //     })
            // }

            html5QrcodeScanner.clear();
        }

        html5QrcodeScanner.render(onScanSuccess);
    });
</script>
</head>

</html>